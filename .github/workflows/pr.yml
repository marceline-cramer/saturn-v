name: Pull Request Checks

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v2
    - uses: actions-rs/cargo@v1
      with:
        command: test
        args: --workspace --exclude saturn-v-check-fuzz
  rustfmt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        components: rustfmt
        override: true
    - uses: LoliGothick/rustfmt-check@master
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        flags: --all
  check-vscode:
    name: "Check VSCode extension"
    runs-on: "ubuntu-latest"
    defaults:
      run:
        working-directory: ./vscode-ext
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v4
      with:
        node-version: 20
    - run: npm install
    - run: npm run compile
  wasm:
    uses: ./.github/workflows/wasm.yml
  examples:
    name: "Run examples"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v2
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
    - name: Build binary
      run: cargo build -p saturn-v
    - name: Run examples
      run: |
        set -euo pipefail
        files=(examples/*.rp1)
        # When the glob doesn't match, bash leaves the pattern unchanged.
        if [ ${#files[@]} -eq 0 ] || [ "${files[0]}" = "examples/*.rp1" ]; then
          echo "No examples found; skipping."
          exit 0
        fi
        for f in "${files[@]}"; do
          echo "Running example: $f"
          cargo run -p saturn-v -- check "$f"
        done
