name: PR

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        rustflags:
    - name: Run Cargo tests
      run: cargo test --workspace --exclude saturn-v-check-fuzz

  rustfmt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt
    - name: Rustfmt Check
      uses: actions-rust-lang/rustfmt@v1

  python-tests:
    name: "Python API tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - run: |
          python -m venv venv
          . venv/bin/activate
          pip install maturin pytest pytest-asyncio
          cd crates/python
          maturin develop
          cd ../..
          pytest crates/python/tests
        shell: bash

  wasm:
    name: WebAssembly packages
    uses: ./.github/workflows/wasm.yml
    with:
      version: ${{ github.head_ref }}

  vscode:
    name: VSCode extension
    uses: ./.github/workflows/vscode.yml
    with:
      version: ${{ github.head_ref }}

  examples:
    name: Examples
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
    - name: Build binary
      run: cargo build -p saturn-v
    - name: Run examples
      run: |
        set -euo pipefail
        files=(examples/*.rp1)
        # When the glob doesn't match, bash leaves the pattern unchanged.
        if [ ${#files[@]} -eq 0 ] || [ "${files[0]}" = "examples/*.rp1" ]; then
          echo "No examples found; skipping."
          exit 0
        fi
        for f in "${files[@]}"; do
          echo "Running example: $f"
          cargo run -p saturn-v -- check "$f"
        done

  msrv:
    name: Verify MSRV
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: Swatinem/rust-cache@v2
    - uses: taiki-e/install-action@cargo-hack
    - name: Check workspace Rust version
      run: cargo hack --workspace --rust-version check
